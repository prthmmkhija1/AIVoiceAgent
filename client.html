<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Voice Agent</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #0f0f1a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    h1 { font-size: 1.6rem; margin-bottom: 0.3rem; color: #fff; }
    .subtitle { color: #888; font-size: 0.85rem; margin-bottom: 1.5rem; }
    .status-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
    }
    .dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #555;
      transition: background 0.3s;
    }
    .dot.connected { background: #4caf50; }
    .dot.error { background: #f44336; }
    .dot.speaking { background: #ff9800; animation: pulse 0.8s infinite alternate; }
    @keyframes pulse { to { opacity: 0.4; } }

    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    button {
      padding: 0.6rem 1.4rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    #btnMic {
      background: #4caf50;
      color: #fff;
      min-width: 160px;
    }
    #btnMic:hover:not(:disabled) { background: #45a049; }
    #btnMic.recording {
      background: #f44336;
      animation: pulse 0.8s infinite alternate;
    }
    #btnInterrupt {
      background: #ff9800;
      color: #fff;
    }
    #btnInterrupt:hover:not(:disabled) { background: #e68900; }
    #btnClear {
      background: #333;
      color: #ccc;
    }
    #btnClear:hover:not(:disabled) { background: #444; }
    #btnEnd {
      background: #f44336;
      color: #fff;
    }
    #btnEnd:hover:not(:disabled) { background: #d32f2f; }

    .chat-box {
      width: 100%;
      max-width: 640px;
      flex: 1;
      background: #1a1a2e;
      border-radius: 12px;
      padding: 1rem;
      overflow-y: auto;
      max-height: 55vh;
      min-height: 200px;
      border: 1px solid #2a2a3e;
    }
    .msg {
      margin-bottom: 0.75rem;
      padding: 0.6rem 0.9rem;
      border-radius: 10px;
      max-width: 85%;
      line-height: 1.45;
      font-size: 0.9rem;
      word-wrap: break-word;
    }
    .msg.user {
      background: #2d4a7a;
      margin-left: auto;
      border-bottom-right-radius: 3px;
    }
    .msg.assistant {
      background: #2a2a3e;
      margin-right: auto;
      border-bottom-left-radius: 3px;
    }
    .msg.system {
      background: transparent;
      color: #666;
      font-size: 0.78rem;
      text-align: center;
      max-width: 100%;
      padding: 0.3rem;
    }
    .msg .label {
      font-size: 0.7rem;
      color: #888;
      margin-bottom: 0.2rem;
    }
    .interim {
      color: #999;
      font-style: italic;
    }

    .metrics {
      margin-top: 1rem;
      width: 100%;
      max-width: 640px;
      font-size: 0.75rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>ğŸ™ï¸ AI Voice Agent</h1>
  <p class="subtitle">Speak into your microphone to chat with Nova</p>

  <div class="status-bar">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Disconnected</span>
    <span id="sessionInfo" style="color:#555; margin-left:0.5rem;"></span>
  </div>

  <div class="controls">
    <button id="btnMic" disabled>ğŸ¤ Start Speaking</button>
    <button id="btnInterrupt" disabled>â¹ Interrupt</button>
    <button id="btnClear" disabled>ğŸ—‘ Clear</button>
    <button id="btnEnd" disabled>âŒ Disconnect</button>
    <!-- Connect button style -->
    <style>
      .connect-btn { background: #4caf50 !important; }
      .connect-btn:hover { background: #45a049 !important; }
    </style>
  </div>

  <div class="chat-box" id="chatBox"></div>
  <div class="metrics" id="metrics"></div>

  <script>
    const WS_URL = `ws://${location.hostname || 'localhost'}:8080`;
    const SAMPLE_RATE = 16000;

    let ws = null;
    let audioCtx = null;
    let mediaStream = null;
    let scriptProcessor = null;
    let sessionId = null;
    let isRecording = false;
    let interimEl = null;

    // Audio playback
    let playbackCtx = null;
    let audioQueue = [];
    let audioSampleRate = 24000;
    let isReceivingAudio = false;
    let audioChunks = [];

    // DOM
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const sessionInfo = document.getElementById('sessionInfo');
    const btnMic = document.getElementById('btnMic');
    const btnInterrupt = document.getElementById('btnInterrupt');
    const btnClear = document.getElementById('btnClear');
    const btnEnd = document.getElementById('btnEnd');
    const chatBox = document.getElementById('chatBox');
    const metricsEl = document.getElementById('metrics');

    // â”€â”€â”€ Connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function connect() {
      setStatus('connecting', 'Connecting...');
      ws = new WebSocket(WS_URL);
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        setStatus('connected', 'Connected');
        btnMic.disabled = false;
        btnClear.disabled = false;
        btnEnd.disabled = false;
      };

      ws.onmessage = (evt) => {
        if (typeof evt.data === 'string') {
          handleJsonMessage(JSON.parse(evt.data));
        } else {
          handleAudioData(evt.data);
        }
      };

      ws.onclose = () => {
        setStatus('disconnected', 'Disconnected');
        stopRecording();
        btnMic.disabled = true;
        btnInterrupt.disabled = true;
        btnClear.disabled = true;
        btnEnd.disabled = false;
        btnEnd.textContent = 'ğŸ”Œ Connect';
        btnEnd.classList.add('connect-btn');
        sessionId = null;
        addSystemMsg('Session ended. Click Connect to start a new conversation.');
      };

      ws.onerror = () => {
        setStatus('error', 'Connection error');
      };
    }

    // â”€â”€â”€ Handle JSON messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function handleJsonMessage(data) {
      switch (data.type) {
        case 'connected':
          sessionId = data.sessionId;
          sessionInfo.textContent = `Session: ${sessionId.slice(0, 8)}...`;
          addSystemMsg(`Connected: ${data.message}`);
          break;

        case 'transcript':
          if (data.isFinal) {
            if (interimEl) { interimEl.remove(); interimEl = null; }
            addMsg('user', data.text);
          } else {
            showInterim(data.text);
          }
          break;

        case 'response':
          addMsg('assistant', data.text);
          break;

        case 'thinking':
          setStatus('speaking', 'Nova is thinking...');
          addSystemMsg('ğŸ’­ Thinking...');
          break;

        case 'speaking':
          setStatus('speaking', 'Nova is speaking...');
          btnInterrupt.disabled = false;
          break;

        case 'audio_start':
          isReceivingAudio = true;
          audioChunks = [];
          if (data.sampleRate) audioSampleRate = data.sampleRate;
          break;

        case 'audio_end':
          isReceivingAudio = false;
          btnInterrupt.disabled = true;
          setStatus('connected', 'Connected');
          playAudioChunks();
          break;

        case 'audio_interrupted':
          isReceivingAudio = false;
          audioChunks = [];
          btnInterrupt.disabled = true;
          setStatus('connected', 'Connected');
          addSystemMsg('â¹ Response interrupted');
          break;

        case 'error':
          addSystemMsg(`âŒ ${data.message}`);
          break;
      }
    }

    // â”€â”€â”€ Audio playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function handleAudioData(arrayBuffer) {
      if (isReceivingAudio) {
        audioChunks.push(new Uint8Array(arrayBuffer));
      }
    }

    function playAudioChunks() {
      if (audioChunks.length === 0) return;

      // Merge all chunks
      const totalLen = audioChunks.reduce((s, c) => s + c.length, 0);
      const merged = new Uint8Array(totalLen);
      let offset = 0;
      for (const chunk of audioChunks) {
        merged.set(chunk, offset);
        offset += chunk.length;
      }
      audioChunks = [];

      // Convert linear16 (int16) to float32
      const int16 = new Int16Array(merged.buffer);
      const float32 = new Float32Array(int16.length);
      for (let i = 0; i < int16.length; i++) {
        float32[i] = int16[i] / 32768;
      }

      // Play via Web Audio API
      if (!playbackCtx) playbackCtx = new AudioContext({ sampleRate: audioSampleRate });
      const buf = playbackCtx.createBuffer(1, float32.length, audioSampleRate);
      buf.copyToChannel(float32, 0);
      const src = playbackCtx.createBufferSource();
      src.buffer = buf;
      src.connect(playbackCtx.destination);
      src.start();
    }

    // â”€â”€â”€ Microphone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startRecording() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: { sampleRate: SAMPLE_RATE, channelCount: 1, echoCancellation: true }
        });

        audioCtx = new AudioContext({ sampleRate: SAMPLE_RATE });
        const source = audioCtx.createMediaStreamSource(mediaStream);

        // ScriptProcessor for raw PCM (4096 buffer)
        scriptProcessor = audioCtx.createScriptProcessor(4096, 1, 1);
        scriptProcessor.onaudioprocess = (e) => {
          if (!isRecording || !ws || ws.readyState !== WebSocket.OPEN) return;

          const float32 = e.inputBuffer.getChannelData(0);
          // Convert float32 â†’ int16
          const int16 = new Int16Array(float32.length);
          for (let i = 0; i < float32.length; i++) {
            const s = Math.max(-1, Math.min(1, float32[i]));
            int16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
          }
          ws.send(int16.buffer);
        };

        source.connect(scriptProcessor);
        scriptProcessor.connect(audioCtx.destination);

        isRecording = true;
        btnMic.textContent = 'â¹ Stop Speaking';
        btnMic.classList.add('recording');
        setStatus('connected', 'Listening...');
      } catch (err) {
        addSystemMsg(`âŒ Microphone error: ${err.message}`);
      }
    }

    function stopRecording() {
      const wasRecording = isRecording;
      isRecording = false;
      if (scriptProcessor) { scriptProcessor.disconnect(); scriptProcessor = null; }
      if (audioCtx) { audioCtx.close(); audioCtx = null; }
      if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
      btnMic.textContent = 'ğŸ¤ Start Speaking';
      btnMic.classList.remove('recording');
      if (wasRecording && ws && ws.readyState === WebSocket.OPEN) {
        setStatus('connected', 'Ready â€” Tap Start Speaking when you\'re ready');
        addSystemMsg('ğŸ¤ Microphone stopped. Tap "Start Speaking" to continue the conversation.');
      }
    }

    // â”€â”€â”€ UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setStatus(state, text) {
      statusDot.className = 'dot';
      if (state === 'connected' || state === 'speaking') statusDot.classList.add(state);
      else if (state === 'error') statusDot.classList.add('error');
      statusText.textContent = text;
    }

    function addMsg(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = role === 'user' ? 'ğŸ§‘ You' : 'ğŸ¤– Nova';
      div.appendChild(label);
      div.appendChild(document.createTextNode(text));
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addSystemMsg(text) {
      const div = document.createElement('div');
      div.className = 'msg system';
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showInterim(text) {
      if (!interimEl) {
        interimEl = document.createElement('div');
        interimEl.className = 'msg user interim';
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = 'ğŸ§‘ You (listening...)';
        interimEl.appendChild(label);
        interimEl.appendChild(document.createTextNode(''));
        chatBox.appendChild(interimEl);
      }
      interimEl.lastChild.textContent = text;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // â”€â”€â”€ Button handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    btnMic.addEventListener('click', () => {
      if (isRecording) stopRecording();
      else startRecording();
    });

    btnInterrupt.addEventListener('click', () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'interrupt' }));
      }
    });

    btnClear.addEventListener('click', () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'clear' }));
        chatBox.innerHTML = '';
        addSystemMsg('Conversation cleared');
      }
    });

    btnEnd.addEventListener('click', () => {
      if (btnEnd.classList.contains('connect-btn')) {
        // Reconnect
        btnEnd.textContent = 'âŒ Disconnect';
        btnEnd.classList.remove('connect-btn');
        chatBox.innerHTML = '';
        connect();
      } else {
        // Disconnect
        stopRecording();
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'end' }));
          ws.close();
        }
      }
    });

    // â”€â”€â”€ Auto-connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    connect();
  </script>
</body>
</html>
