<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Voice Agent</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #0f0f1a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    h1 {
      font-size: 1.8em;
      margin-bottom: 8px;
      color: #fff;
    }

    .subtitle {
      color: #888;
      margin-bottom: 30px;
      font-size: 0.9em;
    }

    /* Status indicator */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
      padding: 10px 20px;
      background: #1a1a2e;
      border-radius: 20px;
      font-size: 0.85em;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4444;
      transition: background 0.3s;
    }

    .status-dot.connected { background: #44ff44; }
    .status-dot.listening { background: #44aaff; animation: pulse 1s infinite; }
    .status-dot.thinking  { background: #ffaa44; animation: pulse 0.5s infinite; }
    .status-dot.speaking  { background: #aa44ff; animation: pulse 0.8s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Mic button */
    .mic-container {
      margin: 20px 0 30px;
    }

    .mic-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid #333;
      background: #1a1a2e;
      color: #888;
      font-size: 2.5em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mic-btn:hover { border-color: #44aaff; color: #44aaff; }
    .mic-btn.active {
      border-color: #ff4444;
      color: #ff4444;
      background: #2a1a1e;
      animation: pulse 1.5s infinite;
    }

    /* Chat log */
    .chat-container {
      width: 100%;
      max-width: 600px;
      flex: 1;
    }

    .chat-log {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 20px;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 12px;
    }

    .message {
      margin-bottom: 16px;
      padding: 10px 14px;
      border-radius: 10px;
      max-width: 85%;
      line-height: 1.5;
      font-size: 0.95em;
    }

    .message.user {
      background: #1e3a5f;
      margin-left: auto;
      text-align: right;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      background: #2a2a4a;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .message .label {
      font-size: 0.7em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .message.interim {
      opacity: 0.5;
      font-style: italic;
    }

    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .controls button {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #1a1a2e;
      color: #aaa;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.2s;
    }

    .controls button:hover {
      border-color: #44aaff;
      color: #fff;
    }

    .error {
      color: #ff6b6b;
      background: #2a1a1e;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 0.85em;
    }
  </style>
</head>
<body>

  <h1>ğŸ™ï¸ AI Voice Agent</h1>
  <p class="subtitle">Powered by Deepgram STT/TTS + Grok LLM</p>

  <div class="status-bar">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Disconnected</span>
  </div>

  <div class="mic-container">
    <button class="mic-btn" id="micBtn" onclick="toggleMic()">ğŸ¤</button>
  </div>

  <div class="chat-container">
    <div class="chat-log" id="chatLog"></div>
    <div class="controls">
      <button onclick="connectWS()">ğŸ”Œ Connect</button>
      <button onclick="clearChat()">ğŸ—‘ï¸ Clear Chat</button>
      <button onclick="disconnectWS()">âŒ Disconnect</button>
    </div>
  </div>

  <script>
    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let ws = null;
    let mediaStream = null;
    let audioContext = null;
    let processor = null;
    let isRecording = false;

    const WS_URL = 'ws://localhost:8080';

    // â”€â”€â”€ DOM Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const micBtn = document.getElementById('micBtn');
    const chatLog = document.getElementById('chatLog');

    // â”€â”€â”€ Audio Playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let audioQueue = [];        // Queue of audio buffers to play
    let isPlaying = false;
    let playbackContext = null;

    // â”€â”€â”€ WebSocket Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function connectWS() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        addSystemMessage('Already connected');
        return;
      }

      setStatus('connecting', 'Connecting...');
      ws = new WebSocket(WS_URL);

      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        setStatus('connected', 'Connected â€” Press the mic to start talking');
        addSystemMessage('Connected to AI Voice Agent');
      };

      ws.onmessage = (event) => {
        if (event.data instanceof ArrayBuffer) {
          // Binary = audio from TTS
          audioQueue.push(event.data);
          if (!isPlaying) playNextAudio();
        } else {
          // JSON = text messages
          const msg = JSON.parse(event.data);
          handleServerMessage(msg);
        }
      };

      ws.onclose = () => {
        setStatus('disconnected', 'Disconnected');
        stopRecording();
      };

      ws.onerror = (error) => {
        setStatus('disconnected', 'Connection error');
        addErrorMessage('WebSocket error. Is the server running?');
      };
    }

    function disconnectWS() {
      if (ws) {
        ws.send(JSON.stringify({ type: 'end' }));
        ws.close();
        ws = null;
      }
      stopRecording();
      setStatus('disconnected', 'Disconnected');
    }

    // â”€â”€â”€ Handle Server Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function handleServerMessage(msg) {
      switch (msg.type) {
        case 'connected':
          console.log('Session:', msg.sessionId);
          break;

        case 'transcript':
          // Show what the user is saying
          updateInterimTranscript(msg.text, msg.isFinal);
          break;

        case 'response':
          // Show AI response text
          addMessage('assistant', msg.text);
          break;

        case 'thinking':
          setStatus('thinking', 'Nova is thinking...');
          break;

        case 'speaking':
          setStatus('speaking', 'Nova is speaking...');
          break;

        case 'audio_start':
          audioQueue = [];      // Clear any leftover audio
          isPlaying = false;
          break;

        case 'audio_end':
          // All audio chunks received, start playing
          setStatus('connected', 'Connected â€” Press the mic to talk');
          break;

        case 'error':
          addErrorMessage(msg.message);
          break;
      }
    }

    // â”€â”€â”€ Microphone Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function toggleMic() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        addErrorMessage('Connect to the server first!');
        return;
      }

      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    }

    async function startRecording() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            sampleRate: 16000,
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true,
          }
        });

        audioContext = new AudioContext({ sampleRate: 16000 });
        const source = audioContext.createMediaStreamSource(mediaStream);

        // ScriptProcessor to capture audio data
        processor = audioContext.createScriptProcessor(4096, 1, 1);
        processor.onaudioprocess = (event) => {
          if (!isRecording || !ws || ws.readyState !== WebSocket.OPEN) return;

          const inputData = event.inputBuffer.getChannelData(0);
          // Convert Float32 â†’ Int16 (linear16)
          const int16 = new Int16Array(inputData.length);
          for (let i = 0; i < inputData.length; i++) {
            const s = Math.max(-1, Math.min(1, inputData[i]));
            int16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
          }

          ws.send(int16.buffer);
        };

        source.connect(processor);
        processor.connect(audioContext.destination);

        isRecording = true;
        micBtn.classList.add('active');
        setStatus('listening', 'Listening... Speak now!');

      } catch (error) {
        addErrorMessage('Microphone access denied. Please allow mic access.');
        console.error('Mic error:', error);
      }
    }

    function stopRecording() {
      isRecording = false;
      micBtn.classList.remove('active');

      if (processor) {
        processor.disconnect();
        processor = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }

      if (ws && ws.readyState === WebSocket.OPEN) {
        setStatus('connected', 'Connected â€” Press the mic to talk');
      }
    }

    // â”€â”€â”€ Audio Playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function playNextAudio() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        return;
      }

      isPlaying = true;

      // Combine all queued chunks into one buffer
      const combined = combineBuffers(audioQueue);
      audioQueue = [];

      try {
        if (!playbackContext) {
          playbackContext = new AudioContext({ sampleRate: 24000 });
        }

        // Convert Int16 â†’ Float32 for Web Audio API
        const int16 = new Int16Array(combined);
        const float32 = new Float32Array(int16.length);
        for (let i = 0; i < int16.length; i++) {
          float32[i] = int16[i] / 0x7FFF;
        }

        const audioBuffer = playbackContext.createBuffer(1, float32.length, 24000);
        audioBuffer.getChannelData(0).set(float32);

        const source = playbackContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(playbackContext.destination);

        source.onended = () => {
          // Check if more audio arrived while playing
          if (audioQueue.length > 0) {
            playNextAudio();
          } else {
            isPlaying = false;
          }
        };

        source.start();
      } catch (error) {
        console.error('Playback error:', error);
        isPlaying = false;
      }
    }

    function combineBuffers(buffers) {
      const totalLength = buffers.reduce((acc, buf) => acc + buf.byteLength, 0);
      const combined = new Uint8Array(totalLength);
      let offset = 0;
      for (const buf of buffers) {
        combined.set(new Uint8Array(buf), offset);
        offset += buf.byteLength;
      }
      return combined.buffer;
    }

    // â”€â”€â”€ UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let interimElement = null;

    function updateInterimTranscript(text, isFinal) {
      if (isFinal) {
        // Remove interim and add final message
        if (interimElement) {
          interimElement.remove();
          interimElement = null;
        }
        addMessage('user', text);
      } else {
        // Show/update interim transcript
        if (!interimElement) {
          interimElement = document.createElement('div');
          interimElement.className = 'message user interim';
          chatLog.appendChild(interimElement);
        }
        interimElement.innerHTML = `<div class="label">You (listening...)</div>${text}`;
        chatLog.scrollTop = chatLog.scrollHeight;
      }
    }

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      const label = role === 'user' ? 'You' : 'ğŸ¤– Nova';
      div.innerHTML = `<div class="label">${label}</div>${text}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.style.cssText = 'text-align:center; color:#666; font-size:0.8em; margin:8px 0;';
      div.textContent = `â€” ${text} â€”`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function addErrorMessage(text) {
      const div = document.createElement('div');
      div.className = 'error';
      div.textContent = `âš ï¸ ${text}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function clearChat() {
      chatLog.innerHTML = '';
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'clear' }));
        addSystemMessage('Chat cleared');
      }
    }

    function setStatus(state, text) {
      statusDot.className = 'status-dot ' + state;
      statusText.textContent = text;
    }

    // â”€â”€â”€ Auto-connect on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('load', () => {
      addSystemMessage('Click "Connect" to start, then press the mic button');
    });
  </script>

</body>
</html>
